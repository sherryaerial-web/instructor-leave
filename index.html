<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ•™å¸«è«‹å‡ç³»çµ± | Instructor Leave</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==">
  
  <style>
    :root {
      --primary-color: #0071e3;
      --bg-color: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #1d1d1f;
      --text-sub: #6e6e73; /* ç¨å¾®æ·±ä¸€é»çš„ç°è‰²ï¼Œæ›´æœ‰è³ªæ„Ÿ */
      --border-radius: 18px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Noto Sans TC", sans-serif; 
      margin: 0; background: var(--bg-color); color: var(--text-main); 
    }

    .header { text-align: center; padding: 40px 20px 20px; }
    .header h1 { font-size: 24px; font-weight: 700; margin: 0; }

    .wrap { max-width: 500px; margin: 0 auto; padding: 15px; }

    .card { 
      background: var(--card-bg); border-radius: var(--border-radius); 
      padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    label { display: block; font-weight: 700; margin-bottom: 16px; font-size: 16px; color: var(--text-main); }

    select { 
      width: 100%; font-size: 16px; padding: 14px; border-radius: 12px; 
      border: 1px solid #d2d2d7; background: #fff; outline: none; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center;
    }

    /* æ—¥æœŸç¶²æ ¼ */
    .date-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
    .date-item { 
      border: 1.5px solid #d2d2d7; padding: 12px 5px; border-radius: 14px; 
      text-align: center; cursor: pointer; transition: 0.2s; background: #fff;
    }
    .date-item .day-name { font-size: 11px; font-weight: 700; color: var(--primary-color); display: block; margin-bottom: 2px; }
    .date-item .date-val { font-size: 14px; font-weight: 600; }
    .date-item.active { background: var(--primary-color); border-color: var(--primary-color); color: #fff; }
    .date-item.active .day-name { color: rgba(255,255,255,0.9); }

    /* èª²ç¨‹æ¸…å–® - è³ªæ„Ÿå‡ç´š */
    .list { display: grid; gap: 12px; }
    .item { 
      display: flex; gap: 14px; border: 1.5px solid #f2f2f2; padding: 20px; 
      border-radius: 16px; align-items: flex-start; cursor: pointer; transition: 0.2s;
    }
    .item:hover { border-color: #d2d2d7; }
    .item input[type="checkbox"] { 
      width: 22px; height: 22px; accent-color: var(--primary-color); 
      margin-top: 2px; flex-shrink: 0; cursor: pointer;
    }
    
    .item-content { flex: 1; }
    
    /* ç¬¬ä¸€è¡Œï¼šè¼”åŠ©è³‡è¨Š (æ—¥æœŸã€æ™‚é–“) */
    .item-meta { 
      font-size: 13px; /* ç¨å¾®å°ä¸€é» */
      color: var(--text-sub); 
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* ç¬¬äºŒè¡Œï¼šä¸»è¦è³‡è¨Š (èª²ç¨‹åç¨±) */
    .item-title { 
      font-size: 18px; /* åŠ å¤§å­—é«” */
      font-weight: 700; 
      color: var(--text-main);
      line-height: 1.3;
    }

    button#submit { 
      width: 100%; font-size: 17px; font-weight: 700; padding: 18px; border-radius: 16px; 
      border: 0; background: var(--primary-color); color: #fff; cursor: pointer; 
      transition: 0.3s; margin-top: 10px;
    }
    button#submit:disabled { background: #d2d2d7; cursor: not-allowed; }

    /* å½ˆçª— */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
    .modal { background: #fff; padding: 40px 30px; border-radius: 28px; max-width: 320px; width: 100%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .modal-btn { background: #000; color: #fff; border: 0; width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 20px; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 8888; }
    .loader { width: 30px; height: 30px; border: 3px solid #d2d2d7; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="loader"></div><div style="color: #86868b;">åŒæ­¥é›²ç«¯èª²è¡¨...</div></div>

<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <span style="font-size:50px; display:block; margin-bottom:15px;">âœ…</span>
    <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">ç”³è«‹å·²é€å‡º</div>
    <div style="color: #86868b; line-height: 1.5;">è«‹å‡ç´€éŒ„å·²æ›´æ–°ã€‚</div>
    <button class="modal-btn" onclick="location.reload()">ç¢ºå®š</button>
  </div>
</div>

<div class="header"><h1>æ•™å¸«è«‹å‡ç³»çµ±</h1></div>

<div class="wrap">
  <div class="card"><label>1. æ‚¨çš„å§“å</label><select id="instructor"><option value="">è®€å–ä¸­...</option></select></div>
  <div class="card"><label>2. é¸æ“‡è«‹å‡æ—¥æœŸ</label><div id="dateGrid" class="date-grid"></div></div>
  <div id="courseCard" class="card" style="display:none;"><label>3. å‹¾é¸æ¬²è«‹å‡çš„èª²å ‚</label><div id="classList" class="list"></div></div>
  <button id="submit" disabled>ç¢ºèªé€å‡º</button>
</div>

<script>
const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
let rawData = [];
let selectedDates = new Set();

function getDayName(dateStr) {
  const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
  const safeStr = dateStr.replace(/\//g, '-');
  const d = new Date(safeStr);
  return days[d.getDay()] || '';
}

window.onload = function() {
  fetch(`${APP_URL}?action=getCourse`, { redirect: 'follow' })
    .then(res => res.json())
    .then(data => {
      rawData = data;
      const names = [...new Set(data.map(d => d['æŒ‡å°è€…']).filter(n => n && n !== "æŒ‡å°è€…"))].sort();
      document.getElementById('instructor').innerHTML = '<option value="">è«‹é»æ“Šé¸æ“‡å§“å</option>' + 
        names.map(n => `<option value="${n}">${n}</option>`).join('');
      document.getElementById('loading').style.display = 'none';
    });
};

document.getElementById('instructor').onchange = function() {
  selectedDates.clear(); refreshCourseList();
  const selIns = this.value;
  if (!selIns) { document.getElementById('dateGrid').innerHTML = ''; return; }
  const dates = [...new Set(rawData.filter(d => d['æŒ‡å°è€…'] === selIns).map(d => d['æ—¥æœŸ']))].sort();
  document.getElementById('dateGrid').innerHTML = dates.map(d => `
    <div class="date-item" onclick="toggleDate(this, '${d}')">
      <span class="day-name">${getDayName(d)}</span>
      <span class="date-val">${d.split('/').slice(1).join('/')}</span>
    </div>
  `).join('');
};

function toggleDate(el, date) {
  selectedDates.has(date) ? selectedDates.delete(date) : selectedDates.add(date);
  el.classList.toggle('active');
  refreshCourseList();
}

function refreshCourseList() {
  const listEl = document.getElementById('classList');
  listEl.innerHTML = '';
  if (selectedDates.size === 0) { document.getElementById('courseCard').style.display = 'none'; document.getElementById('submit').disabled = true; return; }
  document.getElementById('courseCard').style.display = 'block';
  const classes = rawData.filter(item => item['æŒ‡å°è€…'] === document.getElementById('instructor').value && selectedDates.has(item['æ—¥æœŸ']));
  
  classes.forEach(c => {
    const div = document.createElement('div');
    div.className = 'item';
    div.onclick = () => { const chk = div.querySelector('input'); chk.checked = !chk.checked; updateBtn(); };
    
    // è¦–è¦ºå¼·åŒ–ï¼šç¬¬ä¸€è¡Œç°è‰²å°å­—(æ—¥æœŸæ™‚é–“)ï¼Œç¬¬äºŒè¡Œé»‘è‰²å¤§å­—(èª²ç¨‹å)
    div.innerHTML = `
      <input type="checkbox" data-course="${c['èª²ç¨‹']}" data-date="${c['æ—¥æœŸ']}" data-time="${c['æ™‚é–“']}" onclick="event.stopPropagation(); updateBtn();">
      <div class="item-content">
        <div class="item-meta">
          <span>ğŸ“… ${c['æ—¥æœŸ']} (${getDayName(c['æ—¥æœŸ'])})</span>
          <span>ğŸ•’ ${c['æ™‚é–“']}</span>
        </div>
        <div class="item-title">${c['èª²ç¨‹']}</div>
      </div>`;
    listEl.appendChild(div);
  });
  updateBtn();
}

function updateBtn() { document.getElementById('submit').disabled = !document.getElementById('classList').querySelector('input:checked'); }

document.getElementById('submit').onclick = function() {
  this.disabled = true; this.textContent = 'è™•ç†ä¸­...';
  const items = [...document.getElementById('classList').querySelectorAll('input:checked')].map(cb => ({
    course_name: cb.dataset.course, start_time: cb.dataset.time, date: cb.dataset.date
  }));
  const params = new URLSearchParams({ instructor: document.getElementById('instructor').value, items: JSON.stringify(items) });
  fetch(`${APP_URL}?${params.toString()}`, { mode: "no-cors" })
    .then(() => { document.getElementById('modalOverlay').style.display = 'flex'; });
};
</script>
</body>
</html>
