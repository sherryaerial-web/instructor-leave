<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>教師請假系統 | Instructor Leave</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==">
  
  <style>
    :root {
      --primary-color: #0071e3;
      --bg-color: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #1d1d1f;
      --text-sub: #86868b;
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Noto Sans TC", sans-serif; 
      margin: 0; background: var(--bg-color); color: var(--text-main); 
    }

    .header { text-align: center; padding: 40px 20px 20px; }
    .header h1 { font-size: 26px; font-weight: 700; margin: 0; }
    .header p { color: var(--text-sub); margin-top: 6px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

    .wrap { max-width: 500px; margin: 0 auto; padding: 20px; }

    .card { 
      background: var(--card-bg); border-radius: var(--border-radius); 
      padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);
    }
    label { display: block; font-weight: 600; margin-bottom: 16px; font-size: 17px; }

    select { 
      width: 100%; font-size: 16px; padding: 14px; border-radius: 12px; 
      border: 1px solid #d2d2d7; background: #fff; outline: none; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center;
    }

    /* 日期按鈕網格 */
    .date-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
    .date-item { 
      border: 1.5px solid #d2d2d7; padding: 12px 6px; border-radius: 12px; 
      text-align: center; cursor: pointer; transition: all 0.2s;
      background: #fff; display: flex; flex-direction: column; gap: 4px;
    }
    .date-item .day-name { font-size: 12px; font-weight: 800; color: var(--primary-color); }
    .date-item .date-val { font-size: 14px; font-weight: 500; color: var(--text-main); }
    
    .date-item.active { 
      background: var(--primary-color); border-color: var(--primary-color); 
      box-shadow: 0 4px 12px rgba(0,113,227,0.3);
    }
    .date-item.active .day-name, .date-item.active .date-val { color: #fff; }

    /* 課程清單優化 */
    .list { display: grid; gap: 12px; }
    .item { 
      display: flex; gap: 16px; border: 1.5px solid #f2f2f2; padding: 18px; 
      border-radius: 14px; align-items: flex-start; cursor: pointer; transition: 0.2s;
    }
    .item:hover { border-color: var(--primary-color); background: #fafafa; }
    .item input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--primary-color); margin-top: 4px; flex-shrink: 0; }
    
    /* 課堂文字顯示樣式 */
    .item-content { flex: 1; line-height: 1.6; }
    .course-info-line { font-size: 16px; color: var(--text-main); font-weight: 500; }
    .course-name-line { font-size: 16px; color: var(--text-main); font-weight: 700; margin-top: 2px; }

    button#submit { 
      width: 100%; font-size: 18px; font-weight: 600; padding: 18px; border-radius: 14px; 
      border: 0; background: var(--primary-color); color: #fff; cursor: pointer; 
      transition: 0.3s; margin-top: 10px;
    }
    button#submit:disabled { background: #d2d2d7; cursor: not-allowed; }

    /* 彈跳視窗 */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
      display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px;
    }
    .modal { background: #fff; padding: 40px 30px; border-radius: 28px; max-width: 320px; width: 100%; text-align: center; }
    .modal-icon { font-size: 50px; margin-bottom: 15px; display: block; }
    .modal-btn { background: #000; color: #fff; border: 0; width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 20px; }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 8888; }
    .loader { width: 30px; height: 30px; border: 3px solid #d2d2d7; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="loader"></div><div style="color: #86868b;">同步雲端課表...</div></div>

<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <span class="modal-icon">✅</span>
    <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">申請已送出</div>
    <div style="color: #86868b; line-height: 1.5;">請假紀錄已更新，<br>您可以關閉此網頁。</div>
    <button class="modal-btn" onclick="location.reload()">確定</button>
  </div>
</div>

<div class="header"><h1>教師請假系統</h1><p>Leave Request</p></div>

<div class="wrap">
  <div class="card"><label>1. 您的姓名</label><select id="instructor"><option value="">讀取中...</option></select></div>
  <div class="card"><label>2. 選擇請假日期</label><div id="dateGrid" class="date-grid"></div></div>
  <div id="courseCard" class="card" style="display:none;"><label>3. 勾選課堂</label><div id="classList" class="list"></div></div>
  <button id="submit" disabled>確認送出</button>
</div>

<script>
const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
let rawData = [];
let selectedDates = new Set();

function getDayName(dateStr) {
  const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
  const safeStr = dateStr.replace(/\//g, '-');
  const d = new Date(safeStr);
  return days[d.getDay()] || '';
}

window.onload = function() {
  fetch(`${APP_URL}?action=getCourse`, { redirect: 'follow' })
    .then(res => res.json())
    .then(data => {
      rawData = data;
      const names = [...new Set(data.map(d => d['指導者']).filter(n => n && n !== "指導者"))].sort();
      document.getElementById('instructor').innerHTML = '<option value="">請點擊選擇</option>' + 
        names.map(n => `<option value="${n}">${n}</option>`).join('');
      document.getElementById('loading').style.display = 'none';
    });
};

document.getElementById('instructor').onchange = function() {
  selectedDates.clear(); refreshCourseList();
  const selIns = this.value;
  if (!selIns) { document.getElementById('dateGrid').innerHTML = ''; return; }
  const dates = [...new Set(rawData.filter(d => d['指導者'] === selIns).map(d => d['日期']))].sort();
  document.getElementById('dateGrid').innerHTML = dates.map(d => `
    <div class="date-item" onclick="toggleDate(this, '${d}')">
      <span class="day-name">${getDayName(d)}</span>
      <span class="date-val">${d.split('/').slice(1).join('/')}</span>
    </div>
  `).join('');
};

function toggleDate(el, date) {
  selectedDates.has(date) ? selectedDates.delete(date) : selectedDates.add(date);
  el.classList.toggle('active');
  refreshCourseList();
}

function refreshCourseList() {
  const listEl = document.getElementById('classList');
  listEl.innerHTML = '';
  if (selectedDates.size === 0) { document.getElementById('courseCard').style.display = 'none'; document.getElementById('submit').disabled = true; return; }
  document.getElementById('courseCard').style.display = 'block';
  const classes = rawData.filter(item => item['指導者'] === document.getElementById('instructor').value && selectedDates.has(item['日期']));
  
  classes.forEach(c => {
    const div = document.createElement('div');
    div.className = 'item';
    div.onclick = () => { const chk = div.querySelector('input'); chk.checked = !chk.checked; updateBtn(); };
    
    // 關鍵修改：符合您要求的兩行顯示格式
    div.innerHTML = `
      <input type="checkbox" data-course="${c['課程']}" data-date="${c['日期']}" data-time="${c['時間']}" onclick="event.stopPropagation(); updateBtn();">
      <div class="item-content">
        <div class="course-info-line">${c['日期']} (${getDayName(c['日期'])}) &nbsp; ${c['時間']}</div>
        <div class="course-name-line">${c['課程']}</div>
      </div>`;
    listEl.appendChild(div);
  });
  updateBtn();
}

function updateBtn() { document.getElementById('submit').disabled = !document.getElementById('classList').querySelector('input:checked'); }

document.getElementById('submit').onclick = function() {
  this.disabled = true; this.textContent = '傳送中...';
  const items = [...document.getElementById('classList').querySelectorAll('input:checked')].map(cb => ({
    course_name: cb.dataset.course, start_time: cb.dataset.time, date: cb.dataset.date
  }));
  const params = new URLSearchParams({ instructor: document.getElementById('instructor').value, items: JSON.stringify(items) });
  fetch(`${APP_URL}?${params.toString()}`, { mode: "no-cors" })
    .then(() => { document.getElementById('modalOverlay').style.display = 'flex'; });
};
</script>
</body>
</html>
